<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>WAR ZONE V3.1</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Inconsolata:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none;}
:root{--primary:#00ff88;--secondary:#ff0055;--bg:#0a0e27;--panel:rgba(21,27,58,0.95);}
html,body{width:100%;height:100%;background:var(--bg);color:#fff;font-family:'Inconsolata',monospace;overflow:hidden;}

.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;}
.screen.active{display:flex;}

/* LOGIN SCREEN */
#loginScreen{align-items:center;justify-content:center;background:rgba(10,14,39,0.97);}
.login-container{background:linear-gradient(135deg,#151b3a,#0f1428);border:2px solid var(--primary);padding:2rem;border-radius:20px;max-width:400px;width:90%;}
.login-title{font-family:'Righteous',sans-serif;font-size:2rem;color:var(--primary);margin-bottom:1.5rem;text-align:center;}
.login-input{width:100%;background:rgba(15,20,40,0.8);border:2px solid rgba(0,255,136,0.3);color:#fff;padding:.8rem;margin-bottom:.8rem;font-family:monospace;border-radius:8px;font-size:1rem;}
.login-btn{width:100%;background:linear-gradient(135deg,var(--primary),#00dd88);color:#000;border:none;padding:.8rem;font-weight:bold;cursor:pointer;border-radius:8px;margin-bottom:.5rem;min-height:44px;font-size:1rem;}
.login-btn:hover{transform:scale(1.02);}
.login-btn:disabled{opacity:0.5;cursor:not-allowed;}

/* GARAGE/LOBBY SCREEN */
#garageScreen{flex-direction:column;background:var(--bg);z-index:100;}
#garageContent{display:flex;height:100%;overflow:hidden;}
#garageLeft{flex:1;padding:20px;border-right:2px solid var(--primary);overflow-y:auto;background:rgba(0,0,0,0.3);}
#garageRight{flex:2;padding:20px;overflow-y:auto;}
.garage-title{font-family:'Righteous',sans-serif;font-size:1.5rem;color:var(--primary);margin-bottom:15px;border-bottom:2px solid var(--primary);padding-bottom:10px;}
.player-info{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);padding:12px;border-radius:8px;margin-bottom:15px;}
.player-info p{font-size:.85rem;margin:5px 0;color:#ccc;}
.player-info p span{color:var(--primary);font-weight:bold;}
.units-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;}
.unit-card{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.3);padding:10px;border-radius:8px;cursor:pointer;transition:all .2s;text-align:center;}
.unit-card:hover{background:rgba(0,255,136,0.2);border-color:var(--primary);}
.unit-card .icon{font-size:2rem;margin-bottom:5px;}
.unit-card .name{font-size:.7rem;font-weight:bold;color:var(--primary);}
.unit-card .cost{font-size:.6rem;color:#888;}
.unit-card .count{background:var(--secondary);color:#fff;padding:2px 6px;border-radius:4px;font-size:.6rem;margin-top:5px;display:inline-block;}
.opponents-list{display:flex;flex-direction:column;gap:10px;}
.opponent{background:rgba(0,255,136,0.1);border:2px solid rgba(0,255,136,0.3);padding:12px;border-radius:8px;cursor:pointer;transition:all .2s;}
.opponent:hover{background:rgba(0,255,136,0.2);border-color:var(--primary);}
.opponent.selected{background:rgba(255,0,85,0.2);border-color:var(--secondary);}
.opponent-name{font-weight:bold;color:#fff;font-size:.85rem;}
.opponent-stats{font-size:.7rem;color:#aaa;margin-top:5px;}
.garage-buttons{display:flex;gap:10px;margin-top:20px;}
.garage-btn{flex:1;padding:12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:.85rem;transition:all .2s;}
.btn-start{background:linear-gradient(135deg,var(--primary),#00dd88);color:#000;}
.btn-start:hover{transform:scale(1.05);}
.btn-back{background:rgba(100,100,100,0.3);color:#ccc;border:1px solid rgba(100,100,100,0.5);}
.btn-back:hover{background:rgba(100,100,100,0.5);}

/* GAME SCREEN */
#gameScreen{flex-direction:column;background:#000;z-index:50;}
#topBar{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--panel);border-bottom:2px solid var(--primary);flex-shrink:0;flex-wrap:wrap;}
.top-stat{font-size:.7rem;padding:3px 8px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:6px;white-space:nowrap;}
.top-stat span{color:var(--primary);font-weight:bold;}
.top-btn{background:rgba(0,255,136,0.15);border:1px solid rgba(0,255,136,0.4);color:var(--primary);padding:4px 10px;border-radius:6px;cursor:pointer;font-family:monospace;font-size:.7rem;font-weight:bold;white-space:nowrap;}
.top-btn:hover{background:rgba(0,255,136,0.3);}
#topBar .spacer{flex:1;}
#middle{display:flex;flex:1;overflow:hidden;gap:6px;padding:6px;}
#canvasWrap{flex:1;position:relative;border:2px solid var(--primary);border-radius:10px;overflow:hidden;background:#000;cursor:crosshair;}
#gameCanvas{width:100%;height:100%;display:block;}
#minimap{position:absolute;bottom:8px;right:8px;width:130px;height:100px;border:1px solid rgba(0,255,136,0.5);border-radius:4px;background:rgba(5,8,20,0.85);cursor:pointer;}
#zoomCtrl{position:absolute;bottom:8px;left:8px;display:flex;flex-direction:column;gap:4px;}
.zoom-btn{width:32px;height:32px;background:rgba(0,0,0,0.7);border:1px solid rgba(0,255,136,0.5);color:var(--primary);border-radius:6px;cursor:pointer;font-size:1.2rem;}
#zoomLabel{color:var(--primary);font-size:.6rem;text-align:center;background:rgba(0,0,0,0.6);padding:1px 4px;}
#spawnBar{width:72px;flex-shrink:0;display:flex;flex-direction:column;gap:5px;overflow-y:auto;background:var(--panel);border:2px solid var(--primary);border-radius:10px;padding:5px;}
.spawn-btn{width:60px;height:60px;background:rgba(0,255,136,0.12);border:2px solid rgba(0,255,136,0.35);border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:.5rem;color:#ccc;font-family:monospace;transition:all .15s;position:relative;flex-shrink:0;}
.spawn-btn:hover{background:rgba(0,255,136,0.25);border-color:var(--primary);}
.spawn-btn .icon{font-size:1.4rem;}
.spawn-btn .name{font-size:.45rem;color:var(--primary);font-weight:bold;}
.spawn-btn .cost{font-size:.4rem;color:#aaa;}

.game-over{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:999;}
.game-over-card{background:#151b3a;border:3px solid var(--primary);padding:2rem;border-radius:16px;text-align:center;max-width:380px;}
.game-over-title{font-family:'Righteous',sans-serif;font-size:1.8rem;margin-bottom:1rem;color:var(--primary);}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="screen active">
  <div class="login-container">
    <div class="login-title">‚öîÔ∏è WAR ZONE V3.1</div>
    <input type="text" id="serverUrl" class="login-input" placeholder="Server URL" value="">
    <button class="login-btn" onclick="connectServer()">üîó CONNECT</button>
    <input type="text" id="playerName" class="login-input" placeholder="Numele tƒÉu" value="Alpha" disabled>
    <button class="login-btn" id="loginBtn" onclick="goToGarage()" style="display:none;" disabled>INTRƒÇ √éN GARAJ</button>
  </div>
</div>

<!-- GARAGE/LOBBY SCREEN -->
<div id="garageScreen" class="screen">
  <div style="display:flex;align-items:center;padding:10px;background:var(--panel);border-bottom:2px solid var(--primary);">
    <div style="flex:1;font-family:'Righteous',sans-serif;color:var(--primary);font-size:1.2rem;">üèóÔ∏è GARAJUL TƒÇU</div>
    <button class="top-btn" onclick="backToLogin()" style="background:rgba(255,0,85,0.2);color:#ff0055;">‚Üê BACK</button>
  </div>
  <div id="garageContent">
    <div id="garageLeft">
      <div class="garage-title">üë§ PROFIL</div>
      <div class="player-info">
        <p>JucƒÉtor: <span id="garagePlayerName">-</span></p>
        <p>Team: <span id="garageTeam">-</span></p>
        <p>üí∞ <span id="garageGold">0</span>G</p>
        <p>‚ö° <span id="garageEnergy">0</span>E</p>
      </div>

      <div class="garage-title">ü™ñ UNITƒÇ»öILOR</div>
      <div class="units-grid" id="garageUnits"></div>

      <div class="garage-buttons">
        <button class="garage-btn btn-start" onclick="startWar()">‚öîÔ∏è START WAR</button>
      </div>
    </div>

    <div id="garageRight">
      <div class="garage-title">‚öîÔ∏è ALEGE ADVERSAR</div>
      <div class="opponents-list" id="opponentsList"></div>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <div id="topBar">
    <div class="top-stat">üë§ <span id="playerNameDisplay">-</span></div>
    <div class="top-stat">ü™ñ <span id="unitsCount">0</span></div>
    <div class="top-stat">üíÄ <span id="killsCount">0</span></div>
    <div class="top-stat">üí∞ <span id="goldDisplay">0</span>G</div>
    <div class="top-stat">‚ö° <span id="energyDisplay">0</span>E</div>
    <div class="spacer"></div>
    <button class="top-btn" onclick="backToGarage()">‚Üê GARAJ</button>
  </div>
  <div id="middle">
    <div id="canvasWrap">
      <canvas id="gameCanvas"></canvas>
      <div id="zoomCtrl">
        <button class="zoom-btn" onclick="changeZoom(0.2)">Ôºã</button>
        <div id="zoomLabel">100%</div>
        <button class="zoom-btn" onclick="changeZoom(-0.2)">Ôºç</button>
      </div>
      <canvas id="minimap"></canvas>
    </div>
    <div id="spawnBar"></div>
  </div>
</div>

<script>
const UNIT_DEFS = {
  soldier:    { icon:'üë§', name:'SOLDIER',    hp:30,  dmg:10, gold:30,  energy:20  },
  tank:       { icon:'üõ°Ô∏è', name:'TANK',       hp:120, dmg:22, gold:100, energy:50  },
  fighter:    { icon:'‚úàÔ∏è', name:'FIGHTER',    hp:50,  dmg:35, gold:150, energy:80  },
  cannon:     { icon:'üî´', name:'CANNON',     hp:40,  dmg:50, gold:200, energy:100 },
  helicopter: { icon:'üöÅ', name:'HELI',       hp:60,  dmg:40, gold:250, energy:120 },
  bomber:     { icon:'üí£', name:'BOMBER',     hp:70,  dmg:65, gold:300, energy:150 },
  collector:  { icon:'üì¶', name:'COLLECTOR',  hp:25,  dmg:0,  gold:20,  energy:10  },
  constructor:{ icon:'üèóÔ∏è', name:'CONSTRUCTOR',hp:35, dmg:5,  gold:80,  energy:60  },
  turret:     { icon:'üî´', name:'TURRET',     hp:80,  dmg:45, gold:150, energy:100 },
  barracks:   { icon:'üèõÔ∏è', name:'BARRACKS',   hp:100, dmg:0,  gold:200, energy:150 }
};
const UNIT_KEYS = Object.keys(UNIT_DEFS);

const state = {
  connected: false,
  myPlayerId: null,
  myPlayer: null,
  players: [],
  units: [],
  bases: [],
  resourceNodes: [],
  projectiles: [],
  obstacles: [],
  gameStatus: 'waiting',
  selectedUnits: new Set(),
  mapWidth: 1000,
  mapHeight: 800,
  selectedOpponent: null,
  unitCounts: {}
};

let ws = null;
let gameOverShown = false;
let selectedEnemyId = null;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const miniCvs = document.getElementById('minimap');
const miniCtx = miniCvs.getContext('2d');
miniCvs.width = 130;
miniCvs.height = 100;

let camX = 0, camY = 0, zoom = 1.0;
const GAME_W = 1000, GAME_H = 800;

function resizeCanvas() {
  const r = canvas.parentElement.getBoundingClientRect();
  canvas.width = r.width;
  canvas.height = r.height;
  clampCamera();
}
new ResizeObserver(resizeCanvas).observe(canvas.parentElement);
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function changeZoom(delta) {
  zoom = Math.max(0.4, Math.min(3.0, zoom + delta));
  document.getElementById('zoomLabel').textContent = Math.round(zoom * 100) + '%';
  clampCamera();
}

function clampCamera() {
  const vw = canvas.width / zoom;
  const vh = canvas.height / zoom;
  camX = Math.max(0, Math.min(GAME_W - vw, camX));
  camY = Math.max(0, Math.min(GAME_H - vh, camY));
}

function gToC(gx, gy) { return { x: (gx - camX) * zoom, y: (gy - camY) * zoom }; }
function cToG(cx, cy) { return { x: cx / zoom + camX, y: cy / zoom + camY }; }

function switchScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function connectServer() {
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = document.getElementById('serverUrl').value || `${protocol}://${location.host}`;
  ws = new WebSocket(url);
  ws.onopen = () => {
    state.connected = true;
    document.getElementById('playerName').disabled = false;
    document.getElementById('loginBtn').disabled = false;
    document.getElementById('loginBtn').style.display = 'block';
  };
  ws.onclose = () => { state.connected = false; };
  ws.onerror = () => { state.connected = false; };
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'PLAYERS_LIST') {
        updatePlayersList(msg.players || []);
      } else if (msg.type === 'GAME_STATE') {
        updateGameState(msg);
      } else if (msg.type === 'JOIN_CONFIRMED') {
        state.myPlayerId = msg.playerId;
        state.myPlayer = {
          id: msg.playerId,
          name: document.getElementById('playerName').value,
          team: msg.team,
          kills: 0,
          gold: 500,
          energy: 100,
          baseX: msg.baseX,
          baseY: msg.baseY
        };
        switchScreen('gameScreen');
        startGameLoop();
      }
    } catch(e) { console.error(e); }
  };
}

function goToGarage() {
  const name = document.getElementById('playerName').value;
  if (!name.trim() || !state.connected) return;
  
  switchScreen('garageScreen');
  
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'GET_PLAYERS' }));
  }
  
  buildGarage();
  updateGarageUI();
}

function buildGarage() {
  const garageUnits = document.getElementById('garageUnits');
  garageUnits.innerHTML = UNIT_KEYS.map(type => {
    const d = UNIT_DEFS[type];
    return `
      <div class="unit-card" onclick="selectUnit('${type}')">
        <div class="icon">${d.icon}</div>
        <div class="name">${d.name}</div>
        <div class="cost">${d.gold}G</div>
        <div class="count" id="count_${type}">0</div>
      </div>
    `;
  }).join('');
}

function updateGarageUI() {
  if (!state.myPlayer) return;
  document.getElementById('garagePlayerName').textContent = state.myPlayer.name;
  document.getElementById('garageTeam').textContent = state.myPlayer.team.toUpperCase();
  document.getElementById('garageGold').textContent = Math.round(state.myPlayer.gold);
  document.getElementById('garageEnergy').textContent = Math.round(state.myPlayer.energy);
}

function updatePlayersList(players) {
  const list = document.getElementById('opponentsList');
  list.innerHTML = players.filter(p => p.id !== state.myPlayerId).map(p => `
    <div class="opponent ${selectedEnemyId === p.id ? 'selected' : ''}" onclick="selectOpponent('${p.id}', this)">
      <div class="opponent-name">${p.name}</div>
      <div class="opponent-stats">Team: ${p.team.toUpperCase()} | Kills: ${p.kills}</div>
    </div>
  `).join('');
}

function selectOpponent(playerId, el) {
  document.querySelectorAll('.opponent').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedEnemyId = playerId;
}

function selectUnit(type) {
  console.log('Selected unit:', type);
}

function startWar() {
  if (!selectedEnemyId) {
    alert('Alege adversar!');
    return;
  }
  const name = document.getElementById('playerName').value;
  if (!name.trim() || !ws || ws.readyState !== WebSocket.OPEN) return;
  
  ws.send(JSON.stringify({ type: 'JOIN_GAME', playerName: name }));
}

function backToLogin() {
  switchScreen('loginScreen');
  if (ws) ws.close();
  ws = null;
  state.connected = false;
}

function backToGarage() {
  switchScreen('garageScreen');
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'GET_PLAYERS' }));
  }
}

function updateGameState(msg) {
  state.players = msg.players || [];
  state.units = msg.units || [];
  state.bases = msg.bases || [];
  state.resourceNodes = msg.resourceNodes || [];
  state.projectiles = msg.projectiles || [];
  state.obstacles = msg.obstacles || [];
  state.gameStatus = msg.gameStatus || 'waiting';
  state.mapWidth = msg.mapWidth || 1000;
  state.mapHeight = msg.mapHeight || 800;
  
  if (state.myPlayerId) {
    const me = state.players.find(p => p.id === state.myPlayerId);
    if (me) state.myPlayer = me;
  }
  updateGameUI();
}

function updateGameUI() {
  if (!state.myPlayer) return;
  document.getElementById('playerNameDisplay').textContent = state.myPlayer.name;
  document.getElementById('unitsCount').textContent = state.units.filter(u => u.playerId === state.myPlayerId).length;
  document.getElementById('killsCount').textContent = state.myPlayer.kills;
  document.getElementById('goldDisplay').textContent = Math.round(state.myPlayer.gold);
  document.getElementById('energyDisplay').textContent = Math.round(state.myPlayer.energy);
}

function buildSpawnBar() {
  const bar = document.getElementById('spawnBar');
  bar.innerHTML = UNIT_KEYS.map(type => {
    const d = UNIT_DEFS[type];
    return `
      <div class="spawn-btn" ondblclick="spawnUnit('${type}')">
        <div class="icon">${d.icon}</div>
        <div class="name">${d.name}</div>
        <div class="cost">${d.gold}G</div>
      </div>
    `;
  }).join('');
}

function spawnUnit(type) {
  if (!ws || ws.readyState !== WebSocket.OPEN || !state.myPlayer) return;
  ws.send(JSON.stringify({ type: 'SPAWN_UNIT', unitType: type }));
}

const TEAM_COLORS = {
  blue: '#0088ff', red: '#ff2200', green: '#00ff00',
  yellow: '#ffff00', purple: '#ff00ff', orange: '#ff8800'
};

function drawGame() {
  const W = canvas.width, H = canvas.height;
  if (!W || !H) return;

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#000e1e';
  ctx.fillRect(0, 0, W, H);

  ctx.strokeStyle = 'rgba(0,255,136,0.03)';
  const gridSz = 40 * zoom;
  const offX = ((-camX * zoom) % gridSz + gridSz) % gridSz;
  const offY = ((-camY * zoom) % gridSz + gridSz) % gridSz;
  for (let x = offX - gridSz; x < W + gridSz; x += gridSz) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = offY - gridSz; y < H + gridSz; y += gridSz) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  state.obstacles.forEach(obs => {
    const { x, y } = gToC(obs.x, obs.y);
    ctx.fillStyle = obs.type === 'rock' ? 'rgba(100,100,100,0.6)' : 'rgba(34,139,34,0.4)';
    ctx.beginPath(); ctx.arc(x, y, obs.radius * zoom, 0, Math.PI * 2); ctx.fill();
  });

  state.resourceNodes.forEach(node => {
    const { x, y } = gToC(node.x, node.y);
    ctx.fillStyle = 'rgba(255,200,0,0.5)';
    ctx.beginPath(); ctx.arc(x, y, 11 * zoom, 0, Math.PI * 2); ctx.fill();
  });

  state.bases.forEach(base => {
    const { x, y } = gToC(base.x, base.y);
    const color = TEAM_COLORS[base.team] || '#fff';
    const sz = 22 * zoom;
    ctx.fillStyle = color + '44'; ctx.fillRect(x - sz, y - sz, sz * 2, sz * 2);
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.strokeRect(x - sz, y - sz, sz * 2, sz * 2);
  });

  state.units.forEach(u => {
    const { x, y } = gToC(u.x, u.y);
    const color = TEAM_COLORS[u.team] || '#fff';
    const sz = 5 * zoom;
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI * 2); ctx.fill();
    if (state.selectedUnits.has(u.id)) {
      ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(x, y, sz * 1.5, 0, Math.PI * 2); ctx.stroke();
    }
  });

  state.projectiles.forEach(proj => {
    const { x, y } = gToC(proj.x, proj.y);
    const color = TEAM_COLORS[proj.team] || '#fff';
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 2 * zoom, 0, Math.PI * 2); ctx.fill();
  });

  drawMinimap();
}

function drawMinimap() {
  const mw = miniCvs.width, mh = miniCvs.height;
  miniCtx.fillStyle = 'rgba(5,8,22,0.92)';
  miniCtx.fillRect(0, 0, mw, mh);
  const sx = mw / GAME_W, sy = mh / GAME_H;
  
  state.bases.forEach(b => {
    miniCtx.fillStyle = TEAM_COLORS[b.team] || '#fff';
    miniCtx.fillRect(b.x * sx - 4, b.y * sy - 4, 8, 8);
  });
  
  state.units.forEach(u => {
    miniCtx.fillStyle = TEAM_COLORS[u.team] || '#fff';
    miniCtx.fillRect(u.x * sx - 1, u.y * sy - 1, 2, 2);
  });
}

function gameLoop() {
  drawGame();
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'GET_STATE' }));
  }
  requestAnimationFrame(gameLoop);
}

function startGameLoop() {
  buildSpawnBar();
  gameLoop();
}

// Initialize
document.getElementById('loginBtn').disabled = true;
document.getElementById('loginBtn').style.display = 'none';
</script>
</body>
</html>
