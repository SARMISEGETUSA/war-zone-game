<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>WAR ZONE V3.2</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Righteous&family=Inconsolata:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none;}
:root{--primary:#00ff88;--secondary:#ff0055;--bg:#0a0e27;--panel:rgba(21,27,58,0.95);--scale:1;}

/* ===== FIX #2: RESPONSIVE SCALING ===== */
html,body{width:100%;height:100%;background:var(--bg);color:#fff;font-family:'Inconsolata',monospace;overflow:hidden;font-size:clamp(10px, 1vw, 18px);}

.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;}
.screen.active{display:flex;}

/* LOGIN SCREEN */
#loginScreen{align-items:center;justify-content:center;background:rgba(10,14,39,0.97);}
.login-container{background:linear-gradient(135deg,#151b3a,#0f1428);border:2px solid var(--primary);padding:clamp(1rem,2vw,2rem);border-radius:20px;max-width:400px;width:90%;}
.login-title{font-family:'Righteous',sans-serif;font-size:clamp(1.5rem,3vw,2rem);color:var(--primary);margin-bottom:clamp(0.8rem,2vh,1.5rem);text-align:center;}
.login-input{width:100%;background:rgba(15,20,40,0.8);border:2px solid rgba(0,255,136,0.3);color:#fff;padding:clamp(0.5rem,1vh,0.8rem);margin-bottom:clamp(0.5rem,1vh,0.8rem);font-family:monospace;border-radius:8px;font-size:clamp(0.8rem,1vw,1rem);}
.login-btn{width:100%;background:linear-gradient(135deg,var(--primary),#00dd88);color:#000;border:none;padding:clamp(0.6rem,1vh,0.8rem);font-weight:bold;cursor:pointer;border-radius:8px;margin-bottom:0.5rem;min-height:44px;font-size:clamp(0.8rem,1vw,1rem);}
.login-btn:hover{transform:scale(1.02);}
.login-btn:disabled{opacity:0.5;cursor:not-allowed;}

/* GARAGE/LOBBY SCREEN */
#garageScreen{flex-direction:column;background:var(--bg);z-index:100;}
#garageContent{display:flex;height:100%;overflow:hidden;gap:clamp(5px,1vw,20px);}
#garageLeft{flex:1;padding:clamp(10px,2vw,20px);border-right:2px solid var(--primary);overflow-y:auto;background:rgba(0,0,0,0.3);}
#garageRight{flex:2;padding:clamp(10px,2vw,20px);overflow-y:auto;}
.garage-title{font-family:'Righteous',sans-serif;font-size:clamp(1.2rem,2vw,1.5rem);color:var(--primary);margin-bottom:clamp(8px,1vh,15px);border-bottom:2px solid var(--primary);padding-bottom:10px;}
.player-info{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);padding:clamp(8px,1vh,12px);border-radius:8px;margin-bottom:clamp(8px,1vh,15px);}
.player-info p{font-size:clamp(0.7rem,0.9vw,0.85rem);margin:5px 0;color:#ccc;}
.player-info p span{color:var(--primary);font-weight:bold;}
.units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:clamp(6px,1vw,10px);margin-bottom:clamp(10px,2vh,20px);}
.unit-card{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.3);padding:clamp(6px,1vh,10px);border-radius:8px;cursor:pointer;transition:all .2s;text-align:center;}
.unit-card:hover{background:rgba(0,255,136,0.2);border-color:var(--primary);}
.unit-card .icon{font-size:clamp(1.5rem,2vw,2rem);margin-bottom:5px;}
.unit-card .name{font-size:clamp(0.5rem,0.8vw,0.7rem);font-weight:bold;color:var(--primary);}
.unit-card .cost{font-size:clamp(0.45rem,0.7vw,0.6rem);color:#888;}
.opponents-list{display:flex;flex-direction:column;gap:clamp(6px,1vh,10px);}
.opponent{background:rgba(0,255,136,0.1);border:2px solid rgba(0,255,136,0.3);padding:clamp(8px,1vh,12px);border-radius:8px;cursor:pointer;transition:all .2s;}
.opponent:hover{background:rgba(0,255,136,0.2);border-color:var(--primary);}
.opponent.selected{background:rgba(255,0,85,0.2);border-color:var(--secondary);}
.opponent-name{font-weight:bold;color:#fff;font-size:clamp(0.75rem,0.9vw,0.85rem);}
.opponent-stats{font-size:clamp(0.6rem,0.8vw,0.7rem);color:#aaa;margin-top:5px;}
.garage-buttons{display:flex;gap:clamp(6px,1vw,10px);margin-top:clamp(10px,2vh,20px);flex-wrap:wrap;}
.garage-btn{flex:1;min-width:100px;padding:clamp(8px,1vh,12px);border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:clamp(0.7rem,0.9vw,0.85rem);transition:all .2s;}
.btn-start{background:linear-gradient(135deg,var(--primary),#00dd88);color:#000;}
.btn-start:hover{transform:scale(1.05);}
.btn-back{background:rgba(100,100,100,0.3);color:#ccc;border:1px solid rgba(100,100,100,0.5);}
.btn-back:hover{background:rgba(100,100,100,0.5);}

/* GAME SCREEN */
#gameScreen{flex-direction:column;background:#000;z-index:50;}
#topBar{display:flex;align-items:center;gap:clamp(3px,0.5vw,8px);padding:clamp(3px,0.5vh,8px);background:var(--panel);border-bottom:2px solid var(--primary);flex-shrink:0;flex-wrap:wrap;}
.top-stat{font-size:clamp(0.6rem,0.8vw,0.8rem);padding:clamp(2px,0.3vh,4px) clamp(4px,1vw,8px);background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:6px;white-space:nowrap;}
.top-stat span{color:var(--primary);font-weight:bold;}
.top-btn{background:rgba(0,255,136,0.15);border:1px solid rgba(0,255,136,0.4);color:var(--primary);padding:clamp(2px,0.4vh,6px) clamp(6px,1vw,10px);border-radius:6px;cursor:pointer;font-family:monospace;font-size:clamp(0.6rem,0.8vw,0.8rem);font-weight:bold;white-space:nowrap;}
.top-btn:hover{background:rgba(0,255,136,0.3);}
#topBar .spacer{flex:1;}

#middle{display:flex;flex:1;overflow:hidden;gap:clamp(3px,0.5vw,8px);padding:clamp(3px,0.5vw,8px);}
#canvasWrap{flex:1;position:relative;border:2px solid var(--primary);border-radius:10px;overflow:hidden;background:#000;cursor:crosshair;}
#gameCanvas{width:100%;height:100%;display:block;}

#rightPanel{display:flex;flex-direction:column;gap:clamp(3px,0.5vw,8px);width:clamp(120px,15vw,250px);overflow:hidden;}
#rightPanel .panel{background:var(--panel);border:2px solid var(--primary);padding:clamp(6px,0.8vh,12px);border-radius:8px;overflow-y:auto;flex:1;}
.panel-title{font-family:'Righteous',sans-serif;font-size:clamp(0.65rem,0.85vw,0.85rem);color:var(--primary);margin-bottom:clamp(4px,0.5vh,8px);text-transform:uppercase;font-weight:bold;}
.stat-item{display:flex;justify-content:space-between;font-size:clamp(0.6rem,0.8vw,0.75rem);margin:clamp(2px,0.3vh,4px) 0;padding:clamp(2px,0.3vh,4px) 0;}
.opponent-item{background:rgba(0,255,136,0.08);border-left:2px solid var(--primary);padding:clamp(4px,0.5vh,8px);margin-bottom:clamp(3px,0.4vh,6px);border-radius:4px;font-size:clamp(0.6rem,0.8vw,0.75rem);}
.opponent-item .name{color:var(--primary);font-weight:bold;}
.opponent-item .stat{color:#aaa;font-size:clamp(0.55rem,0.75vw,0.65rem);}

#spawnBar{width:clamp(60px,8vw,90px);flex-shrink:0;display:flex;flex-direction:column;gap:clamp(3px,0.5vw,6px);overflow-y:auto;background:var(--panel);border:2px solid var(--primary);border-radius:10px;padding:clamp(3px,0.5vh,6px);}
.spawn-btn{width:100%;aspect-ratio:1;background:rgba(0,255,136,0.12);border:2px solid rgba(0,255,136,0.35);border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:clamp(0.45rem,0.65vw,0.55rem);color:#ccc;font-family:monospace;transition:all .15s;flex-shrink:0;}
.spawn-btn:hover{background:rgba(0,255,136,0.25);border-color:var(--primary);}
.spawn-btn .icon{font-size:clamp(1.2rem,2vw,1.8rem);}
.spawn-btn .name{color:var(--primary);font-weight:bold;}
.spawn-btn .cost{color:#aaa;}

/* Responsive adjustments */
@media (max-width: 768px) {
  #garageContent { flex-direction:column; }
  #garageLeft { border-right:none; border-bottom:2px solid var(--primary); }
  #garageRight { max-height:50vh; }
  #middle { flex-direction:column; }
  #rightPanel { width:100%;height:clamp(150px,30vh,300px); flex-direction:row; }
  #rightPanel .panel { flex:1; }
  #spawnBar { width:100%;height:auto;flex-direction:row;overflow-x:auto; }
  .spawn-btn { width:clamp(50px,15vw,80px); }
}

@media (max-width: 480px) {
  .login-container { width:95%; }
  #topBar { font-size:70%; }
  .top-stat { padding:2px 4px; }
  .units-grid { grid-template-columns:repeat(2,1fr); }
}

.game-over{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);z-index:999;}
.game-over-card{background:#151b3a;border:3px solid var(--primary);padding:clamp(1.5rem,3vh,2rem);border-radius:16px;text-align:center;max-width:380px;}
.game-over-title{font-family:'Righteous',sans-serif;font-size:clamp(1.5rem,2.5vw,1.8rem);margin-bottom:1rem;color:var(--primary);}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="screen active">
  <div class="login-container">
    <div class="login-title">‚öîÔ∏è WAR ZONE V3.2</div>
    <input type="text" id="serverUrl" class="login-input" placeholder="Server URL" value="">
    <button class="login-btn" onclick="connectServer()">üîó CONNECT</button>
    <input type="text" id="playerName" class="login-input" placeholder="Numele tƒÉu" value="Alpha" disabled>
    <button class="login-btn" id="loginBtn" onclick="goToGarage()" style="display:none;" disabled>INTRƒÇ √éN GARAJ</button>
  </div>
</div>

<!-- GARAGE/LOBBY SCREEN -->
<div id="garageScreen" class="screen">
  <div style="display:flex;align-items:center;padding:clamp(8px,1vh,12px);background:var(--panel);border-bottom:2px solid var(--primary);flex-wrap:wrap;gap:10px;">
    <div style="flex:1;font-family:'Righteous',sans-serif;color:var(--primary);font-size:clamp(1rem,1.5vw,1.2rem);">üèóÔ∏è GARAJUL TƒÇU</div>
    <button class="top-btn" onclick="backToLogin()" style="background:rgba(255,0,85,0.2);color:#ff0055;">‚Üê BACK</button>
  </div>
  <div id="garageContent">
    <div id="garageLeft">
      <div class="garage-title">üë§ PROFIL</div>
      <div class="player-info">
        <p>Nume: <span id="garageName">-</span></p>
        <p>Gold: <span id="garageGold">500</span></p>
        <p>Energy: <span id="garageEnergy">100</span></p>
      </div>
      <div class="garage-title">‚öîÔ∏è ADVERSARI</div>
      <div class="opponents-list" id="opponentsList"></div>
    </div>
    <div id="garageRight">
      <div class="garage-title">üéñÔ∏è UNITƒÇ»öI</div>
      <div class="units-grid" id="unitsGrid"></div>
      <div class="garage-buttons">
        <button class="garage-btn btn-start" onclick="startWar()">START BATTLE</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <div id="topBar">
    <span class="top-stat">üë§ <span id="playerNameDisplay">-</span></span>
    <span class="top-stat">‚öîÔ∏è <span id="killsCount">0</span></span>
    <span class="top-stat">ü™ñ <span id="unitsCount">0</span></span>
    <span class="top-stat">üí∞ <span id="goldDisplay">500</span></span>
    <span class="top-stat">‚ö° <span id="energyDisplay">100</span></span>
    <div class="spacer"></div>
    <button class="top-btn" onclick="backToGarage()">‚Üê GARAJ</button>
  </div>
  <div id="middle">
    <div id="canvasWrap">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div id="rightPanel">
      <div class="panel">
        <div class="panel-title">üë• PLAYERS</div>
        <div id="playersPanel"></div>
      </div>
      <div id="spawnBar"></div>
    </div>
  </div>
</div>

<script>
const UNIT_DEFS = {
  soldier:    { icon:'üë§', name:'Soldier', gold:30,  energy:20  },
  tank:       { icon:'üõ°Ô∏è',  name:'Tank',    gold:100, energy:50  },
  fighter:    { icon:'‚úàÔ∏è',  name:'Fighter', gold:150, energy:80  },
  cannon:     { icon:'üî´', name:'Cannon',  gold:200, energy:100 },
  helicopter: { icon:'üöÅ', name:'Heli',    gold:250, energy:120 },
  bomber:     { icon:'üí£', name:'Bomber',  gold:300, energy:150 },
  collector:  { icon:'üì¶', name:'Collect', gold:20,  energy:10  }
};
const UNIT_KEYS = Object.keys(UNIT_DEFS);
const TEAM_COLORS = {
  blue: '#0088ff', red: '#ff2200', green: '#00ff00',
  yellow: '#ffff00', purple: '#ff00ff', orange: '#ff8800'
};

const state = {
  connected: false, gameStarted: false, myPlayerId: null, myPlayer: null,
  players: [], units: [], bases: [], resourceNodes: [], gameStatus: 'waiting',
  selectedUnits: new Set(), mapWidth: 1000, mapHeight: 800
};

let ws = null, selectedEnemyId = null, gameOverShown = false;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// ===== FIX #2: Responsive canvas resize =====
function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
}
const resizeObserver = new ResizeObserver(resizeCanvas);
resizeObserver.observe(canvas.parentElement);
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function connectServer() {
  const protocol = location.protocol === "https:" ? "wss" : "ws";
  const input = document.getElementById('serverUrl').value.trim();
  const url = input || `${protocol}://${location.host}`;
  if (!url) return;

  ws = new WebSocket(url);
  ws.onopen = () => {
    state.connected = true;
    updateLoginUI();
  };
  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      if (msg.type === 'JOIN_CONFIRMED') {
        state.myPlayerId = msg.playerId;
        state.myPlayer = {
          id: msg.playerId, name: document.getElementById('playerName').value,
          team: msg.team, kills: 0, gold: 500, energy: 100
        };
        startGame();
      } else if (msg.type === 'GAME_STATE') {
        updateGameState(msg);
      }
    } catch (e) { console.error('Parse error:', e); }
  };
  ws.onerror = () => { state.connected = false; updateLoginUI(); };
  ws.onclose = () => { state.connected = false; updateLoginUI(); };
}

function updateLoginUI() {
  const btn = document.getElementById('loginBtn');
  const input = document.getElementById('playerName');
  if (state.connected) {
    btn.style.display = 'block';
    btn.disabled = false;
    input.disabled = false;
  } else {
    btn.style.display = 'none';
    input.disabled = true;
  }
}

function goToGarage() {
  if (!state.connected) return;
  updateGarageUI();
  switchScreen('garageScreen');
}

// ===== FIX #1: Update players list in garage =====
function updateGarageUI() {
  document.getElementById('garageName').textContent = state.myPlayer?.name || '-';
  document.getElementById('garageGold').textContent = Math.round(state.myPlayer?.gold || 0);
  document.getElementById('garageEnergy').textContent = Math.round(state.myPlayer?.energy || 0);
  
  // Build units grid
  const grid = document.getElementById('unitsGrid');
  grid.innerHTML = UNIT_KEYS.map(type => {
    const d = UNIT_DEFS[type];
    return `<div class="unit-card" onclick="selectUnit('${type}')"><div class="icon">${d.icon}</div><div class="name">${d.name}</div><div class="cost">${d.gold}G</div></div>`;
  }).join('');

  // Update opponents list
  updatePlayersList();
}

// ===== FIX #1: Update players display =====
function updatePlayersList() {
  const list = document.getElementById('opponentsList');
  list.innerHTML = state.players
    .filter(p => p.id !== state.myPlayerId && p.isAlive)
    .map(p => `
      <div class="opponent ${selectedEnemyId === p.id ? 'selected' : ''}" onclick="selectOpponent('${p.id}', this)">
        <div class="opponent-name">${p.name}</div>
        <div class="opponent-stats">Team: ${p.team.toUpperCase()} | Kills: ${p.kills}</div>
      </div>
    `).join('');
}

// ===== FIX #1: Update players panel in game screen =====
function updatePlayersPanel() {
  const panel = document.getElementById('playersPanel');
  panel.innerHTML = state.players
    .filter(p => p.isAlive)
    .map(p => `
      <div class="opponent-item">
        <div class="name">${p.name}</div>
        <div class="stat">Team: ${p.team.toUpperCase()}</div>
        <div class="stat">Kills: ${p.kills}</div>
      </div>
    `).join('');
}

function selectOpponent(playerId, el) {
  document.querySelectorAll('.opponent').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  selectedEnemyId = playerId;
}

function selectUnit(type) {
  console.log('Selected unit:', type);
}

function startWar() {
  if (!selectedEnemyId) {
    alert('Alege adversar!');
    return;
  }
  const name = document.getElementById('playerName').value;
  if (!name.trim() || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'JOIN_GAME', playerName: name }));
}

function backToGarage() {
  switchScreen('garageScreen');
  updateGarageUI();
}

function switchScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function updateGameState(msg) {
  state.players = msg.players || [];
  state.units = msg.units || [];
  state.bases = msg.bases || [];
  state.resourceNodes = msg.resourceNodes || [];
  state.gameStatus = msg.gameStatus || 'waiting';
  state.mapWidth = msg.mapWidth || 1000;
  state.mapHeight = msg.mapHeight || 800;
  
  if (state.myPlayerId) {
    const me = state.players.find(p => p.id === state.myPlayerId);
    if (me) state.myPlayer = me;
  }
  updateGameUI();
}

function startGame() {
  gameOverShown = false;
  switchScreen('gameScreen');
  state.gameStarted = true;
  buildSpawnBar();
  requestGameState();
  gameLoop();
}

function updateGameUI() {
  if (!state.myPlayer) return;
  document.getElementById('playerNameDisplay').textContent = state.myPlayer.name;
  document.getElementById('unitsCount').textContent = state.units.filter(u => u.playerId === state.myPlayerId).length;
  document.getElementById('killsCount').textContent = state.myPlayer.kills;
  document.getElementById('goldDisplay').textContent = Math.round(state.myPlayer.gold);
  document.getElementById('energyDisplay').textContent = Math.round(state.myPlayer.energy);
  
  // ===== FIX #1: Update players panel =====
  updatePlayersPanel();
}

function requestGameState() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'GET_STATE' }));
  }
}

function buildSpawnBar() {
  const bar = document.getElementById('spawnBar');
  bar.innerHTML = UNIT_KEYS.map(type => {
    const d = UNIT_DEFS[type];
    return `
      <div class="spawn-btn" ondblclick="spawnUnit('${type}')">
        <div class="icon">${d.icon}</div>
        <div class="name">${d.name}</div>
        <div class="cost">${d.gold}G</div>
      </div>
    `;
  }).join('');
}

function spawnUnit(type) {
  if (!ws || ws.readyState !== WebSocket.OPEN || !state.myPlayer) return;
  ws.send(JSON.stringify({ type: 'SPAWN_UNIT', unitType: type }));
}

// Canvas controls
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const canvasX = (e.clientX - rect.left) / rect.width * state.mapWidth;
  const canvasY = (e.clientY - rect.top) / rect.height * state.mapHeight;
  selectUnitAtPosition(canvasX, canvasY, e.ctrlKey || e.shiftKey);
});

canvas.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  if (state.selectedUnits.size === 0) return;
  const rect = canvas.getBoundingClientRect();
  const targetX = (e.clientX - rect.left) / rect.width * state.mapWidth;
  const targetY = (e.clientY - rect.top) / rect.height * state.mapHeight;
  moveSelectedUnits(targetX, targetY);
});

function selectUnitAtPosition(canvasX, canvasY, multiSelect) {
  let clicked = null;
  for (const unit of state.units) {
    if (unit.playerId === state.myPlayerId) {
      const dist = Math.hypot(unit.x - canvasX, unit.y - canvasY);
      if (dist < 15) {
        clicked = unit;
        break;
      }
    }
  }

  if (clicked) {
    if (state.selectedUnits.has(clicked.id)) {
      state.selectedUnits.delete(clicked.id);
    } else {
      if (!multiSelect) state.selectedUnits.clear();
      state.selectedUnits.add(clicked.id);
    }
  } else if (!multiSelect) {
    state.selectedUnits.clear();
  }
}

function moveSelectedUnits(targetX, targetY) {
  for (const unitId of state.selectedUnits) {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'MOVE_UNIT', unitId, x: targetX, y: targetY }));
    }
  }
}

function drawGame() {
  const w = canvas.width;
  const h = canvas.height;
  if (w === 0 || h === 0) return;

  ctx.fillStyle = '#0a0e27';
  ctx.fillRect(0, 0, w, h);

  ctx.strokeStyle = 'rgba(0,255,136,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, h);
    ctx.stroke();
  }
  for (let i = 0; i < h; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(w, i);
    ctx.stroke();
  }

  const scaleX = w / state.mapWidth;
  const scaleY = h / state.mapHeight;

  state.bases.forEach(base => {
    const x = base.x * scaleX;
    const y = base.y * scaleY;
    const color = TEAM_COLORS[base.team] || '#fff';

    ctx.fillStyle = color;
    ctx.fillRect(x - 20, y - 20, 40, 40);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.strokeRect(x - 20, y - 20, 40, 40);

    const hPercent = Math.max(0, base.health / base.maxHealth);
    ctx.fillStyle = hPercent > 0.5 ? '#00ff88' : hPercent > 0.25 ? '#ffaa00' : '#ff2200';
    ctx.fillRect(x - 25, y - 30, 50 * hPercent, 3);
  });

  state.units.forEach(unit => {
    const x = unit.x * scaleX;
    const y = unit.y * scaleY;
    const color = TEAM_COLORS[unit.team] || '#fff';
    const size = 6 * Math.min(scaleX, scaleY);

    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();

    if (unit.range > 0) {
      ctx.strokeStyle = color + '30';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(x, y, unit.range * Math.min(scaleX, scaleY), 0, Math.PI * 2);
      ctx.stroke();
    }

    if (state.selectedUnits.has(unit.id)) {
      ctx.strokeStyle = '#ffff00';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y, size + 4, 0, Math.PI * 2);
      ctx.stroke();
    }

    const hPercent = unit.health / unit.maxHealth;
    ctx.fillStyle = hPercent > 0.5 ? '#00ff88' : '#ff8800';
    ctx.fillRect(x - size, y - size - 5, size * 2 * hPercent, 2);
  });
}

function gameLoop() {
  drawGame();
  requestAnimationFrame(gameLoop);
}

setInterval(() => {
  if (state.gameStarted && state.connected) {
    requestGameState();
  }
}, 100);

switchScreen('loginScreen');
</script>
</body>
</html>
